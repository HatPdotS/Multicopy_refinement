============================================================
Testing SolventModel.forward() method
============================================================

1. Loading model and data...
Could not find scattering factor for Ca 2 Exception that was raised: 'NoneType' object has no attribute 'a'
Try without charge
Could not find scattering factor for Mg 2 Exception that was raised: 'NoneType' object has no attribute 'a'
Try without charge
Parametrization built for 9 unique atom types
MapSymmetry initialized for P   1   2 1   1 

  Number of symmetry operations: 2
  Map shape: (223, 277, 251)
MapSymmetry initialized for P   1   2 1   1 

  Number of symmetry operations: 2
  Map shape: (223, 277, 251)
Loading MTZ file: /das/work/p17/p17490/Peter/Library/multicopy_refinement/tests/refinement/dark.mtz
Unit cell: [74.52999877929688, 92.58000183105469, 83.98999786376953, 90.0, 96.70999908447266, 90.0]
Space group: <gemmi.SpaceGroup("P 1 21 1")>
Found intensity data: I-obs (σ: SIGI-obs)
Converting intensities to amplitudes using French-Wilson...
  ✓ I(I-obs) → F (French-Wilson) with σ
Loaded 123647 reflections
Found phase data: PHIF-model (FOM: No)
⚠️  WARNING: Detected inverted R-free convention!
   Original: 0=121647 (98.4%), other=2000 (1.6%)
   Flipping: 0 → work, other → free
   After flip: free=2000 (1.6%), work=121647 (98.4%)
found nan F values:  0
found nan F_sigma values:  0

2. Creating SolventModel...
Initial protein mask (asymmetric unit): 2552564 voxels
After applying symmetry: 5073462 voxels (+2520898)
After dilation (2.0 Å): 11678432 voxels (+6604970)
After erosion (6 voxels): 9176501 voxels (-2501931)
Final protein mask: 9176501 voxels

Final solvent mask: 6328020 voxels (40.8% of unit cell)

3. Computing solvent structure factors for 123647 reflections...

Solvent structure factors computed:
  Shape: torch.Size([123647])
  Dtype: torch.complex64
  Device: cpu
  |F_solvent| mean: 289.1194
  |F_solvent| std: 937.8215
  |F_solvent| max: 26589.4648
  |F_solvent| min: 0.0419

============================================================
4. Testing gradient flow through k_solvent and b_solvent
============================================================

Loss value: 6069045.0000
k_solvent = 0.3500, requires_grad = True
b_solvent = 46.0000, requires_grad = True

Computing gradients...

Gradients:
  dk_solvent/dloss = 17340128.000000
  db_solvent/dloss = -70024.070312

✓ Gradients computed successfully!
  The forward method is differentiable with respect to both parameters.

============================================================
5. Testing parameter effects
============================================================

Effect of k_solvent on |F_solvent|:
  k_solvent = 0.10 → |F_solvent| mean = 320.6570
  k_solvent = 0.35 → |F_solvent| mean = 1122.2993
  k_solvent = 0.50 → |F_solvent| mean = 1603.2849
  k_solvent = 1.00 → |F_solvent| mean = 3206.5698

Effect of b_solvent on |F_solvent|:
  b_solvent = 10.0 → |F_solvent| mean = 1639.2405
  b_solvent = 30.0 → |F_solvent| mean = 1306.2252
  b_solvent = 50.0 → |F_solvent| mean = 1083.5005
  b_solvent = 100.0 → |F_solvent| mean = 738.1595

============================================================
Test completed successfully!
============================================================
