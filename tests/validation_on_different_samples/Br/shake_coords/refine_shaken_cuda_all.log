Loading MTZ file: /das/work/p17/p17490/Peter/Library/multicopy_refinement/tests/validation_on_different_samples/Br/BR_LCLS_refine_8.mtz
Unit cell: [62.31999969482422, 62.31999969482422, 111.0999984741211, 90.0, 90.0, 120.0]
Space group: <gemmi.SpaceGroup("P 63")>
Found intensity data: I-obs (σ: SIGI-obs)
Converting intensities to amplitudes using French-Wilson...
  ✓ I(I-obs) → F (French-Wilson) with σ
Loaded 52123 reflections
Found phase data: PHIF-model (FOM: No)
⚠️  WARNING: Detected inverted R-free convention!
   Original: 0=36523 (70.1%), other=15600 (29.9%)
   Flipping: 0 → work, other → free
   After flip: free=2002 (3.8%), work=50121 (96.2%)
found nan F values:  0
found nan F_sigma values:  0
Filtering: 39030/52123 reflections in range [inf - 1.5] Å

Occupancy Setup:
  Total atoms: 2200
  Collapsed indices: 321
  Alternative conformation groups: 6
  Refinable atoms: 72
  Compression ratio: 6.85x
Parametrization built for 4 unique atom types
MapSymmetry initialized for P       6   3   

  Number of symmetry operations: 6
  Map shape: (124, 124, 222)
Initialized Scaler with 20 bins.
Failed to convert esd column to float for: source_value_dist_nucleus_esd
Failed to convert esd column to float for: source_value_dist_esd
Failed to convert esd column to float for: source_value_angle_esd
Failed to convert esd column to float for: source_value_dist_nucleus_esd
Failed to convert esd column to float for: source_value_dist_esd
Failed to convert esd column to float for: source_value_angle_esd
Found 109 link definitions
Identified restraint keys:
  Bond keys: ['_chem_comp_bond']
  Angle keys: ['_chem_comp_angle']
  Torsion keys: ['_chem_comp_tor']
  Plane keys: ['_chem_comp_plane_atom']
Built 227 peptide bond restraints
Built 681 peptide angle restraints
Built 227 phi angle indices (C-N-CA-C)
Built 227 psi angle indices (N-CA-C-N)
Built 227 omega angle restraints (CA-C-N-CA, ~180°)
  9 omega angles preceding proline residues
Built 227 peptide plane restraints (4 atoms each)
  plan-1: 227 planes
==================================================
Moving refinement to GPU...
==================================================
Model moved to device: cuda
==================================================
Starting refinement on shaken structure...
==================================================
/das/work/p17/p17490/CONDA/muticopy_refinement/lib/python3.12/site-packages/torch/_compile.py:51: UserWarning: optimizer contains a parameter group with duplicate parameters; in future, this will cause an error; see github.com/pytorch/pytorch/issues/40967 for more information
  return disable_fn(*args, **kwargs)
Calculating initial scale factors using 20 bins.
Outlier detection: 7134/52123 (13.69%) outliers found
  Log-ratio statistics: mean=0.025, std=0.545
  Z-score threshold: 4.0
Outlier detection: 7134 reflections flagged as outliers out of 52123.
Outlier detection: 7664/52123 (14.70%) outliers found
  Log-ratio statistics: mean=-0.029, std=0.521
  Z-score threshold: 4.0
Outlier detection: 7664 reflections flagged as outliers out of 52123.
Starting macro cycle 1/5 with learning rate 0.001
  R-work: 0.1978, R-free: 0.2230
Completed macro cycle 1/5. Updated weights: {'xray': 1.0, 'restraints': 0.5}
Calculating initial scale factors using 20 bins.
Outlier detection: 8523/52123 (16.35%) outliers found
  Log-ratio statistics: mean=0.029, std=0.466
  Z-score threshold: 4.0
Outlier detection: 8523 reflections flagged as outliers out of 52123.
Outlier detection: 9611/52123 (18.44%) outliers found
  Log-ratio statistics: mean=0.040, std=0.419
  Z-score threshold: 4.0
Outlier detection: 9611 reflections flagged as outliers out of 52123.
Starting macro cycle 2/5 with learning rate 0.001
  R-work: 0.1720, R-free: 0.2063
Completed macro cycle 2/5. Updated weights: {'xray': 1.0, 'restraints': 0.5}
Calculating initial scale factors using 20 bins.
Outlier detection: 9234/52123 (17.72%) outliers found
  Log-ratio statistics: mean=0.012, std=0.415
  Z-score threshold: 4.0
Outlier detection: 9234 reflections flagged as outliers out of 52123.
Outlier detection: 10165/52123 (19.50%) outliers found
  Log-ratio statistics: mean=-0.007, std=0.388
  Z-score threshold: 4.0
Outlier detection: 10165 reflections flagged as outliers out of 52123.
Starting macro cycle 3/5 with learning rate 0.001
  R-work: 0.1681, R-free: 0.2042
Completed macro cycle 3/5. Updated weights: {'xray': 1.0, 'restraints': 0.5}
Calculating initial scale factors using 20 bins.
Outlier detection: 9617/52123 (18.45%) outliers found
  Log-ratio statistics: mean=0.016, std=0.387
  Z-score threshold: 4.0
Outlier detection: 9617 reflections flagged as outliers out of 52123.
Outlier detection: 10041/52123 (19.26%) outliers found
  Log-ratio statistics: mean=0.079, std=0.374
  Z-score threshold: 4.0
Outlier detection: 10041 reflections flagged as outliers out of 52123.
Starting macro cycle 4/5 with learning rate 0.001
  R-work: 0.1621, R-free: 0.2002
Completed macro cycle 4/5. Updated weights: {'xray': 1.0, 'restraints': 0.5}
Calculating initial scale factors using 20 bins.
Outlier detection: 9877/52123 (18.95%) outliers found
  Log-ratio statistics: mean=0.025, std=0.371
  Z-score threshold: 4.0
Outlier detection: 9877 reflections flagged as outliers out of 52123.
Outlier detection: 10257/52123 (19.68%) outliers found
  Log-ratio statistics: mean=0.028, std=0.366
  Z-score threshold: 4.0
Outlier detection: 10257 reflections flagged as outliers out of 52123.
Starting macro cycle 5/5 with learning rate 0.001
  R-work: 0.1614, R-free: 0.2020
Completed macro cycle 5/5. Updated weights: {'xray': 1.0, 'restraints': 0.5}
