
################################################################################
# ANALYTICAL SCALER TEST SUITE
################################################################################

================================================================================
TEST 1: Basic Initialization
================================================================================

Loading PDB: /das/work/p17/p17490/Peter/Library/multicopy_refinement/test_data/tubulin/dark.pdb
Loading MTZ: /das/work/p17/p17490/Peter/Library/multicopy_refinement/test_data/tubulin/dark.mtz
Could not find scattering factor for Ca 2 Exception that was raised: 'NoneType' object has no attribute 'a'
Try without charge
Could not find scattering factor for Mg 2 Exception that was raised: 'NoneType' object has no attribute 'a'
Try without charge
Parametrization built for 9 unique atom types
MapSymmetry initialized for P   1   2 1   1 

  Number of symmetry operations: 2
  Map shape: (149, 185, 167)
MapSymmetry initialized for P   1   2 1   1 

  Number of symmetry operations: 2
  Map shape: (149, 185, 167)
✓ Model loaded: 9026 atoms
Loading MTZ file: /das/work/p17/p17490/Peter/Library/multicopy_refinement/test_data/tubulin/dark.mtz
Unit cell: [74.52999877929688, 92.58000183105469, 83.98999786376953, 90.0, 96.70999908447266, 90.0]
Space group: <gemmi.SpaceGroup("P 1 21 1")>
Found intensity data: I-obs (σ: SIGI-obs)
Converting intensities to amplitudes using French-Wilson...
  ✓ I(I-obs) → F (French-Wilson) with σ
Loaded 123647 reflections
Found phase data: PHIF-model (FOM: No)
⚠️  WARNING: Detected inverted R-free convention!
   Original: 0=121647 (98.4%), other=2000 (1.6%)
   Flipping: 0 → work, other → free
   After flip: free=2000 (1.6%), work=121647 (98.4%)
found nan F values:  0
found nan F_sigma values:  0
Filtering: 123647/123647 reflections in range [50.0 - 1.5] Å
✓ Data loaded: 123647 reflections
Initial protein mask (asymmetric unit): 757551 voxels
After applying symmetry: 1481254 voxels (+723703)
After dilation (2.0 Å): 3500489 voxels (+2019235)
After erosion (4 voxels): 2822636 voxels (-677853)
Final protein mask: 2822636 voxels

Final solvent mask: 1780719 voxels (38.7% of unit cell)
✓ Solvent mask created

Initializing AnalyticalScaler...

======================================================================
Analytical Bulk-Solvent and Isotropic Scaling
======================================================================
Number of reflections: 123647
Resolution bins: 20

Computing analytical bulk-solvent scales...
  Bin 1/20:  6183 refs, d=1.71Å, k_mask=0.0000, K=322.6404
  Bin 2/20:  6182 refs, d=1.74Å, k_mask=0.0000, K=404.7241
  Bin 3/20:  6183 refs, d=1.78Å, k_mask=0.0444, K=447.1184
  Bin 4/20:  6182 refs, d=1.81Å, k_mask=0.0000, K=513.1166
  Bin 5/20:  6182 refs, d=1.85Å, k_mask=0.0000, K=564.6792
  Bin 6/20:  6183 refs, d=1.89Å, k_mask=0.0000, K=605.1178
  Bin 7/20:  6182 refs, d=1.94Å, k_mask=0.0099, K=550.9341
  Bin 8/20:  6182 refs, d=1.99Å, k_mask=0.0358, K=660.0505
  Bin 9/20:  6183 refs, d=2.04Å, k_mask=0.0000, K=693.0925
  Bin 10/20:  6182 refs, d=2.11Å, k_mask=0.0000, K=714.2495
  Bin 11/20:  6182 refs, d=2.18Å, k_mask=0.0000, K=759.3773
  Bin 12/20:  6183 refs, d=2.26Å, k_mask=0.0000, K=808.3812
  Bin 13/20:  6182 refs, d=2.35Å, k_mask=0.0000, K=856.8000
  Bin 14/20:  6182 refs, d=2.47Å, k_mask=0.0000, K=836.2277
  Bin 15/20:  6183 refs, d=2.61Å, k_mask=0.0000, K=897.0257
  Bin 16/20:  6182 refs, d=2.78Å, k_mask=0.0000, K=938.9446
  Bin 17/20:  6182 refs, d=3.02Å, k_mask=0.0000, K=938.5004
  Bin 18/20:  6183 refs, d=3.37Å, k_mask=0.0000, K=945.7781
  Bin 19/20:  6182 refs, d=3.97Å, k_mask=0.1197, K=1067.2629
  Bin 20/20:  6182 refs, d=5.63Å, k_mask=0.2220, K=1338.2501

Analytical optimization complete:
  Valid bins: 5/20
  k_mask range: 0.0000 - 0.2220
  K range: 322.6404 - 1338.2501
======================================================================
Analytical scaling initialization complete
======================================================================

✓ AnalyticalScaler initialized

✓ All checks passed!
  k_mask computed: 123647 values
  K computed: 123647 values

================================================================================
TEST 2: Forward Pass (Applying Scales)
================================================================================

Applying scales to structure factors...
✓ Forward pass successful
  Input reflections: 123647
  Output F_model: torch.Size([123647])

  F_model amplitude statistics:
    Mean: 29.54
    Std:  35.48
    Min:  0.02
    Max:  496.22

  F_obs amplitude statistics:
    Mean: 29.46
    Std:  35.54
    Min:  0.14
    Max:  380.90

  R-factor: 0.2351

✓ All checks passed!

================================================================================
TEST 3: Forward Pass with Custom HKL
================================================================================

Applying scales to 1000 random reflections...
✓ Forward pass with custom hkl successful
  Input reflections: 1000
  Output F_model: torch.Size([1000])

✓ All checks passed!

================================================================================
TEST 4: Scaling Statistics
================================================================================

Statistics dictionary keys:
  n_bins: 20
  n_reflections: 123647
  kmask_mean: 0.021591730415821075
  kmask_std: 0.05368972569704056
  kmask_min: 0.0
  kmask_max: 0.22202642261981964
  K_mean: 743.1096801757812
  K_std: 240.47189331054688
  K_min: 322.6403503417969
  K_max: 1338.2501220703125

======================================================================
Analytical Scaling Statistics
======================================================================
Total reflections: 123647
Resolution bins: 20

Bulk-solvent scale (k_mask):
  Mean: 0.0216
  Std:  0.0537
  Min:  0.0000
  Max:  0.2220

Isotropic scale parameter (K):
  Mean: 743.1097
  Std:  240.4719
  Min:  322.6404
  Max:  1338.2501
======================================================================

✓ Statistics test passed!

================================================================================
TEST 5: Resolution Bin Information
================================================================================

Bin-by-bin breakdown:
 Bin    d_min    d_max    N_ref     k_mask          K
------------------------------------------------------------
   1     1.70     1.73     6183     0.0000   322.6404
   2     1.73     1.76     6182     0.0000   404.7241
   3     1.76     1.79     6183     0.0444   447.1184
   4     1.79     1.83     6182     0.0000   513.1166
   5     1.83     1.87     6182     0.0000   564.6792
   6     1.87     1.91     6183     0.0000   605.1178
   7     1.91     1.96     6182     0.0099   550.9341
   8     1.96     2.01     6182     0.0358   660.0505
   9     2.01     2.07     6183     0.0000   693.0925
  10     2.07     2.14     6182     0.0000   714.2495
  11     2.14     2.22     6182     0.0000   759.3773
  12     2.22     2.30     6183     0.0000   808.3812
  13     2.30     2.41     6182     0.0000   856.8000
  14     2.41     2.53     6182     0.0000   836.2277
  15     2.53     2.69     6183     0.0000   897.0257
  16     2.69     2.89     6182     0.0000   938.9446
  17     2.89     3.18     6182     0.0000   938.5004
  18     3.18     3.62     6183     0.0000   945.7781
  19     3.62     4.48     6182     0.1197  1067.2629
  20     4.48     9.49     6182     0.2220  1338.2501

✓ Bin information test passed!

================================================================================
Test 6: R-factor Validation
================================================================================

Testing analytical scaler...
  R-factor: 0.2351
  F_model mean: 29.54 (F_obs mean: 29.46)

Testing old scaler for comparison...
  R-factor: 0.2412
  F_model mean: 29.71

✓ Analytical scaler is 2.5% BETTER than old scaler

--------------------------------------------------------------------------------
Summary:
  Analytical scaler: R = 0.2351
  Old scaler:        R = 0.2412
  Difference:        ΔR = -0.0061
--------------------------------------------------------------------------------

✓ R-factor is in excellent range (< 0.3)

✓ R-factor validation completed

================================================================================
Test 7: Anisotropic B-factor Fitting
================================================================================

Before anisotropic fitting:
  R-factor: 0.2351
  F_model mean: 29.54 (F_obs mean: 29.46)

Setting up anisotropic correction...
  ✓ U matrix parameter initialized

Fitting anisotropic B-factors (50 iterations)...

======================================================================
Fitting Anisotropic B-factor Correction
======================================================================
  Iteration 1/50: Loss=30.7486, R-work=0.2330, R-free=0.2466
  Iteration 11/50: Loss=40.5399, R-work=0.2793, R-free=0.2951
  Iteration 21/50: Loss=30.8609, R-work=0.2171, R-free=0.2343
  Iteration 31/50: Loss=27.0443, R-work=0.2022, R-free=0.2193
  Iteration 41/50: Loss=26.8582, R-work=0.2043, R-free=0.2220
  Iteration 50/50: Loss=26.8538, R-work=0.1999, R-free=0.2174
======================================================================
Anisotropic fitting complete
======================================================================

  Final R-work: 0.1999
  Final R-free: 0.2174
  Improvement: 0.0332

After anisotropic fitting:
  R-factor: 0.2000
  F_model mean: 27.84

--------------------------------------------------------------------------------
Summary:
  Before anisotropic: R = 0.2351
  After anisotropic:  R = 0.2000
  Absolute improvement: ΔR = 0.0351
  Relative improvement: 14.9%
--------------------------------------------------------------------------------

✓ Good! R-factor is near target range

Anisotropic U matrix:
  U11=0.007166, U22=0.068798, U33=0.002623
  U12=0.011903, U13=0.080962, U23=0.005523

✓ Anisotropic fitting completed

################################################################################
# ALL TESTS PASSED!
################################################################################


Test completed at Mon Oct 27 18:08:49 CET 2025
