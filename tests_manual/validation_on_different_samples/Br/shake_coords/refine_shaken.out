Loading MTZ file: /das/work/p17/p17490/Peter/Library/multicopy_refinement/tests/validation_on_different_samples/Br/BR_LCLS_refine_8.mtz
Unit cell: [62.31999969482422, 62.31999969482422, 111.0999984741211, 90.0, 90.0, 120.0]
Space group: <gemmi.SpaceGroup("P 63")>
Found intensity data: I-obs (σ: SIGI-obs)
Converting intensities to amplitudes using French-Wilson...
  ✓ I(I-obs) → F (French-Wilson) with σ
Loaded 52123 reflections
Found phase data: PHIF-model (FOM: No)
⚠️  WARNING: Detected inverted R-free convention!
   Original: 0=36523 (70.1%), other=15600 (29.9%)
   Flipping: 0 → work, other → free
   After flip: free=2002 (3.8%), work=50121 (96.2%)
found nan F values:  0
found nan F_sigma values:  0
Filtering: 39030/52123 reflections in range [inf - 1.5] Å
Parametrization built for 4 unique atom types
MapSymmetry initialized for P       6   3   

  Number of symmetry operations: 6
  Map shape: (124, 124, 222)
Initialized Scaler with 20 bins.
Failed to convert esd column to float for: source_value_dist_nucleus_esd
Failed to convert esd column to float for: source_value_dist_esd
Failed to convert esd column to float for: source_value_angle_esd
Failed to convert esd column to float for: source_value_dist_nucleus_esd
Failed to convert esd column to float for: source_value_dist_esd
Failed to convert esd column to float for: source_value_angle_esd
Found 109 link definitions
Identified restraint keys:
  Bond keys: ['_chem_comp_bond']
  Angle keys: ['_chem_comp_angle']
  Torsion keys: ['_chem_comp_tor']
  Plane keys: ['_chem_comp_plane_atom']
Built 227 peptide bond restraints
Built 681 peptide angle restraints
Built 227 phi angle indices (C-N-CA-C)
Built 227 psi angle indices (N-CA-C-N)
Built 227 omega angle restraints (CA-C-N-CA, ~180°)
  9 omega angles preceding proline residues
Built 227 peptide plane restraints (4 atoms each)
  plan-1: 227 planes
==================================================
Moving refinement to GPU...
==================================================
Calculating initial scale factors using 20 bins.
Outlier detection: 7136/52123 (13.69%) outliers found
  Log-ratio statistics: mean=0.022, std=0.545
  Z-score threshold: 4.0
Outlier detection: 7136 reflections flagged as outliers out of 52123.
Outlier detection: 7634/52123 (14.65%) outliers found
  Log-ratio statistics: mean=-0.027, std=0.521
  Z-score threshold: 4.0
Outlier detection: 7634 reflections flagged as outliers out of 52123.
Rfactor before refinement:  (0.24533304572105408, 0.25919222831726074)
==================================================
Starting refinement on shaken structure...
==================================================
/das/work/p17/p17490/CONDA/muticopy_refinement/lib/python3.12/site-packages/torch/_compile.py:51: UserWarning: optimizer contains a parameter group with duplicate parameters; in future, this will cause an error; see github.com/pytorch/pytorch/issues/40967 for more information
  return disable_fn(*args, **kwargs)
Calculating initial scale factors using 20 bins.
Outlier detection: 7949/52123 (15.25%) outliers found
  Log-ratio statistics: mean=0.023, std=0.498
  Z-score threshold: 4.0
Outlier detection: 7949 reflections flagged as outliers out of 52123.
Outlier detection: 8009/52123 (15.37%) outliers found
  Log-ratio statistics: mean=-0.022, std=0.503
  Z-score threshold: 4.0
Outlier detection: 8009 reflections flagged as outliers out of 52123.
Starting macro cycle 1/5 with learning rate 0.001
  R-work: 0.1859, R-free: 0.2157
Completed macro cycle 1/5. Updated weights: {'xray': 1.0, 'restraints': 0.5}
Calculating initial scale factors using 20 bins.
Outlier detection: 8684/52123 (16.66%) outliers found
  Log-ratio statistics: mean=0.033, std=0.453
  Z-score threshold: 4.0
Outlier detection: 8684 reflections flagged as outliers out of 52123.
Outlier detection: 9610/52123 (18.44%) outliers found
  Log-ratio statistics: mean=0.026, std=0.401
  Z-score threshold: 4.0
Outlier detection: 9610 reflections flagged as outliers out of 52123.
Starting macro cycle 2/5 with learning rate 0.001
  R-work: 0.1679, R-free: 0.2037
Completed macro cycle 2/5. Updated weights: {'xray': 1.0, 'restraints': 0.5}
Calculating initial scale factors using 20 bins.
Outlier detection: 9512/52123 (18.25%) outliers found
  Log-ratio statistics: mean=0.012, std=0.397
  Z-score threshold: 4.0
Outlier detection: 9512 reflections flagged as outliers out of 52123.
Outlier detection: 10024/52123 (19.23%) outliers found
  Log-ratio statistics: mean=0.008, std=0.379
  Z-score threshold: 4.0
Outlier detection: 10024 reflections flagged as outliers out of 52123.
Starting macro cycle 3/5 with learning rate 0.001
  R-work: 0.1652, R-free: 0.2038
Completed macro cycle 3/5. Updated weights: {'xray': 1.0, 'restraints': 0.5}
Calculating initial scale factors using 20 bins.
Outlier detection: 9796/52123 (18.79%) outliers found
  Log-ratio statistics: mean=0.018, std=0.376
  Z-score threshold: 4.0
Outlier detection: 9796 reflections flagged as outliers out of 52123.
Outlier detection: 10149/52123 (19.47%) outliers found
  Log-ratio statistics: mean=0.040, std=0.370
  Z-score threshold: 4.0
Outlier detection: 10149 reflections flagged as outliers out of 52123.
Starting macro cycle 4/5 with learning rate 0.001
  R-work: 0.1619, R-free: 0.2014
Completed macro cycle 4/5. Updated weights: {'xray': 1.0, 'restraints': 0.5}
Calculating initial scale factors using 20 bins.
Outlier detection: 9909/52123 (19.01%) outliers found
  Log-ratio statistics: mean=0.022, std=0.369
  Z-score threshold: 4.0
Outlier detection: 9909 reflections flagged as outliers out of 52123.
Outlier detection: 10214/52123 (19.60%) outliers found
  Log-ratio statistics: mean=0.028, std=0.366
  Z-score threshold: 4.0
Outlier detection: 10214 reflections flagged as outliers out of 52123.
Starting macro cycle 5/5 with learning rate 0.001
  R-work: 0.1610, R-free: 0.2024
Completed macro cycle 5/5. Updated weights: {'xray': 1.0, 'restraints': 0.5}
==================================================
Done in 1215.43 seconds
Rfactor after refinement:  (0.16101160645484924, 0.20242507755756378)
==================================================
