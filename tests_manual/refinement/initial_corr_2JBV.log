Loaded CIF file: /das/work/p17/p17490/Peter/Library/multicopy_refinement/scientific_testing/data/4L7Z/4L7Z-sf.cif
  Reflections: 89285
  Has F: True
  Has I: False
  Has R-free: True
  Cell: [ 96.552 157.815 168.112  90.     90.     90.   ]
  Spacegroup: P 2 21 21
found nan F values:  709
found nan F_sigma values:  89285
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/multicopy_refinement/Data.py:886: UserWarning: std(): degrees of freedom is <= 0. Correction should be strictly less than the reduction factor (input numel divided by output numel). (Triggered internally at /pytorch/aten/src/ATen/native/ReduceOps.cpp:1839.)
  std_log_sigma = torch.std(log_sigmas[~flagged_initial])
Suspicious sigma detection: 89285/89285 (100.00%) reflections flagged
nan values in fobs and sigfobs: 0 0
Parametrization built for 4 unique atom types
MapSymmetry initialized for P   2   2 1   2 1        
  Number of symmetry operations: 4
  Map shape: (289, 473, 504)
/var/spool/slurmd/job964764/slurm_script:28: UserWarning: cov(): degrees of freedom is <= 0. Correction should be strictly less than the number of observations. (Triggered internally at /pytorch/aten/src/ATen/native/Correlation.cpp:116.)
  correlation = torch.corrcoef(torch.stack([fobs, torch.abs(fcalc)]))[0, 1].item()
  Resolution bins:
    Bin  0:   4465 refl, resolution 2.50-2.55 Å
    Bin  1:   4464 refl, resolution 2.55-2.59 Å
    Bin  2:   4464 refl, resolution 2.59-2.64 Å
    Bin  3:   4464 refl, resolution 2.64-2.70 Å
    Bin  4:   4465 refl, resolution 2.70-2.76 Å
    Bin  5:   4464 refl, resolution 2.76-2.82 Å
    Bin  6:   4464 refl, resolution 2.82-2.89 Å
    Bin  7:   4464 refl, resolution 2.89-2.97 Å
    Bin  8:   4465 refl, resolution 2.97-3.06 Å
    Bin  9:   4464 refl, resolution 3.06-3.16 Å
    Bin 10:   4464 refl, resolution 3.16-3.28 Å
    Bin 11:   4464 refl, resolution 3.28-3.41 Å
    Bin 12:   4465 refl, resolution 3.41-3.57 Å
    Bin 13:   4464 refl, resolution 3.57-3.76 Å
    Bin 14:   4464 refl, resolution 3.76-4.00 Å
    Bin 15:   4464 refl, resolution 4.00-4.32 Å
    Bin 16:   4465 refl, resolution 4.32-4.76 Å
    Bin 17:   4464 refl, resolution 4.76-5.48 Å
    Bin 18:   4464 refl, resolution 5.48-6.94 Å
    Bin 19:   4464 refl, resolution 6.95-115.06 Å
  Resolution bins:
    Bin  0:   4465 refl, resolution 2.50-2.55 Å
    Bin  1:   4464 refl, resolution 2.55-2.59 Å
    Bin  2:   4464 refl, resolution 2.59-2.64 Å
    Bin  3:   4464 refl, resolution 2.64-2.70 Å
    Bin  4:   4465 refl, resolution 2.70-2.76 Å
    Bin  5:   4464 refl, resolution 2.76-2.82 Å
    Bin  6:   4464 refl, resolution 2.82-2.89 Å
    Bin  7:   4464 refl, resolution 2.89-2.97 Å
    Bin  8:   4465 refl, resolution 2.97-3.06 Å
    Bin  9:   4464 refl, resolution 3.06-3.16 Å
    Bin 10:   4464 refl, resolution 3.16-3.28 Å
    Bin 11:   4464 refl, resolution 3.28-3.41 Å
    Bin 12:   4465 refl, resolution 3.41-3.57 Å
    Bin 13:   4464 refl, resolution 3.57-3.76 Å
    Bin 14:   4464 refl, resolution 3.76-4.00 Å
    Bin 15:   4464 refl, resolution 4.00-4.32 Å
    Bin 16:   4465 refl, resolution 4.32-4.76 Å
    Bin 17:   4464 refl, resolution 4.76-5.48 Å
    Bin 18:   4464 refl, resolution 5.48-6.94 Å
    Bin 19:   4464 refl, resolution 6.95-115.06 Å
Initialized Scaler with 20 bins.

=== Phenix-Style Bulk Solvent Mask Calculation (VECTORIZED) ===
Solvent radius (dilation): 1.10 Å
Shrink truncation radius (erosion): 0.90 Å
Total solvent voxels: 36899945 / 68895288 (53.56%)
Calculating initial scale factors using 20 bins.
Initial scale factors per bin: [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
Initial correlation: nan
Initial R-factor: nan
Loaded CIF file: /das/work/p17/p17490/Peter/Library/multicopy_refinement/scientific_testing/data/4L7Z/4L7Z-sf.cif
  Reflections: 89285
  Has F: True
  Has I: False
  Has R-free: True
  Cell: [ 96.552 157.815 168.112  90.     90.     90.   ]
  Spacegroup: P 2 21 21
found nan F values:  709
found nan F_sigma values:  89285
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/multicopy_refinement/Data.py:886: UserWarning: std(): degrees of freedom is <= 0. Correction should be strictly less than the reduction factor (input numel divided by output numel). (Triggered internally at /pytorch/aten/src/ATen/native/ReduceOps.cpp:1839.)
  std_log_sigma = torch.std(log_sigmas[~flagged_initial])
Suspicious sigma detection: 89285/89285 (100.00%) reflections flagged

Occupancy Setup:
  Total atoms: 16961
  Collapsed indices: 2265
  Alternative conformation groups: 0
  Refinable atoms: 1
  Compression ratio: 7.49x
Building ITC92 parametrization...
Parametrization built for 4 unique atom types
Elements with parametrization: ['C', 'N', 'O', 'S']
Setting up grids with max_res=2.5016095638275146 Å
Defining grid size for =2.5016095638275146 Å
MapSymmetry initialized for P   2   2 1   2 1        
  Number of symmetry operations: 4
  Map shape: (115, 189, 201)
  Resolution bins:
    Bin  0:   4465 refl, resolution 2.50-2.55 Å
    Bin  1:   4464 refl, resolution 2.55-2.59 Å
    Bin  2:   4464 refl, resolution 2.59-2.64 Å
    Bin  3:   4464 refl, resolution 2.64-2.70 Å
    Bin  4:   4465 refl, resolution 2.70-2.76 Å
    Bin  5:   4464 refl, resolution 2.76-2.82 Å
    Bin  6:   4464 refl, resolution 2.82-2.89 Å
    Bin  7:   4464 refl, resolution 2.89-2.97 Å
    Bin  8:   4465 refl, resolution 2.97-3.06 Å
    Bin  9:   4464 refl, resolution 3.06-3.16 Å
    Bin 10:   4464 refl, resolution 3.16-3.28 Å
    Bin 11:   4464 refl, resolution 3.28-3.41 Å
    Bin 12:   4465 refl, resolution 3.41-3.57 Å
    Bin 13:   4464 refl, resolution 3.57-3.76 Å
    Bin 14:   4464 refl, resolution 3.76-4.00 Å
    Bin 15:   4464 refl, resolution 4.00-4.32 Å
    Bin 16:   4465 refl, resolution 4.32-4.76 Å
    Bin 17:   4464 refl, resolution 4.76-5.48 Å
    Bin 18:   4464 refl, resolution 5.48-6.94 Å
    Bin 19:   4464 refl, resolution 6.95-115.06 Å
Initialized Scaler with 20 bins.
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/a/ARG.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/l/LYS.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/l/LEU.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/a/ALA.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/h/HIS.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/a/ASN.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/p/PHE.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/t/TYR.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/p/PRO.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/i/ILE.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/g/GLY.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/g/GLU.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/v/VAL.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/g/GLN.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/a/ASP.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/c/CYS.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/m/MET.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/t/THR.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/t/TRP.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/s/SER.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/t/TRS.cif
Loading link definitions from monomer library...
Found 109 link definitions
Loaded 54 link types
Built 2168 plane restraints with 3 atoms
Built 497 plane restraints with 4 atoms
Built 60 plane restraints with 6 atoms
Built 90 plane restraints with 7 atoms
Built 114 plane restraints with 8 atoms
Peptide bond parameters: C-N = 1.337 Å ± 0.0110 Å
Plane plan-1: 1:CA, 1:C, 2:N, 1:O (σ=0.100 Å)
Plane plan-2: 2:CA, 1:C, 2:H, 2:N (σ=0.100 Å)
Skipping chain break: A:209 → A:214
Skipping chain break: B:209 → B:216
Skipping chain break: C:209 → C:214
Skipping chain break: D:209 → D:214
Skipping chain break: E:209 → E:215
Skipping chain break: F:209 → F:215
Built 2042 peptide bond restraints
Built 6126 peptide angle restraints
Built 2042 peptide plane restraints (4 atoms each)
  plan-1: 2042 planes
Disulfide bond parameters: SG-SG = 2.031 Å ± 0.0200 Å
Found 18 SG atoms
No disulfide bonds found (no SG atoms from different residues within 2.0 Å)
================================================================================
Restraints Summary
================================================================================
CIF file: None
Residue types in dictionary: 21

INTRA-RESIDUE RESTRAINTS:
--------------------------------------------------------------------------------
Bonds: 14328
  Shape: torch.Size([14328, 2])
  References: min=1.236Å, max=1.812Å, mean=1.447Å
  Sigmas: min=0.0100Å, max=0.0200Å, mean=0.0131Å

Angles: 15969
  Shape: torch.Size([15969, 3])
  References: min=100.693°, max=134.327°, mean=113.569°
  Sigmas: min=1.5000°, max=3.0000°, mean=1.9570°

Torsions: 6149
  Shape: torch.Size([6149, 4])
  References: min=-60.000°, max=180.000°, mean=42.787°
  Sigmas: min=5.0000°, max=10.0000°, mean=9.9073°
  Periods: [2, 3, 6]

PEPTIDE LINK RESTRAINTS:
--------------------------------------------------------------------------------
Bonds: 2042
  Shape: torch.Size([2042, 2])
  References: min=1.337Å, max=1.337Å, mean=1.337Å
  Sigmas: min=0.0110Å, max=0.0110Å, mean=0.0110Å

Angles: 6126
  Shape: torch.Size([6126, 3])
  References: min=115.917°, max=123.469°, mean=120.494°
  Sigmas: min=1.5000°, max=1.7600°, mean=1.5867°

BACKBONE TORSION ANGLES:
--------------------------------------------------------------------------------
Phi: 2042
  Definition: C(i) - N(i+1) - CA(i+1) - C(i+1)
  Period: 3

Psi: 2042
  Definition: N(i) - CA(i) - C(i) - N(i+1)
  Period: 2

Omega: 2042
  Definition: CA(i) - C(i) - N(i+1) - CA(i+1)
  References: min=180.00°, max=180.00°, mean=180.00°
  Sigmas: min=5.0000°, max=5.0000°, mean=5.0000°
  Period: 0

PLANE RESTRAINTS:
--------------------------------------------------------------------------------
3_atoms: 2168 planes
  Shape: torch.Size([2168, 3])
  Sigmas: min=0.1000Å, max=0.1000Å, mean=0.1000Å

4_atoms: 2539 planes
  Shape: torch.Size([2539, 4])
  Sigmas: min=0.1000Å, max=0.1000Å, mean=0.1000Å

6_atoms: 60 planes
  Shape: torch.Size([60, 6])
  Sigmas: min=0.1000Å, max=0.1000Å, mean=0.1000Å

7_atoms: 90 planes
  Shape: torch.Size([90, 7])
  Sigmas: min=0.1000Å, max=0.1000Å, mean=0.1000Å

8_atoms: 114 planes
  Shape: torch.Size([114, 8])
  Sigmas: min=0.1000Å, max=0.1000Å, mean=0.1000Å

================================================================================
When using Refinement class:
Initial Rwork: nan, Rfree: nan
Calculated radius for density calculation: 2 voxels (voxel size: tensor([0.8396, 0.8350, 0.8364])), this corresponds to at least 1.1 Å

=== Phenix-Style Bulk Solvent Mask Calculation (VECTORIZED) ===
Solvent radius (dilation): 1.10 Å
Shrink truncation radius (erosion): 0.90 Å
Total solvent voxels: 2255626 / 4368735 (51.63%)
Calculating initial scale factors using 20 bins.
Initial scale factors per bin: [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]
When using Refinement class:
Initial Rwork: nan, Rfree: nan
Traceback (most recent call last):
  File "/var/spool/slurmd/job964764/slurm_script", line 63, in <module>
    Ref.scaler.fit_all_scales()
  File "/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/multicopy_refinement/scaler.py", line 145, in fit_all_scales
    raise ValueError("NaN encountered in NLL loss during scale fitting.")
ValueError: NaN encountered in NLL loss during scale fitting.
