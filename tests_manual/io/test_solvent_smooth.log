============================================================
Testing SolventModel.forward() - Smoothed Mask
============================================================

1. Loading model...
Could not find scattering factor for Ca 2 Exception that was raised: 'NoneType' object has no attribute 'a'
Try without charge
Could not find scattering factor for Mg 2 Exception that was raised: 'NoneType' object has no attribute 'a'
Try without charge
Parametrization built for 9 unique atom types
MapSymmetry initialized for P   1   2 1   1 

  Number of symmetry operations: 2
  Map shape: (223, 277, 251)
MapSymmetry initialized for P   1   2 1   1 

  Number of symmetry operations: 2
  Map shape: (223, 277, 251)

2. Creating SolventModel...
Initial protein mask (asymmetric unit): 2552564 voxels
After applying symmetry: 5073462 voxels (+2520898)
After dilation (2.0 Å): 11678432 voxels (+6604970)
After erosion (6 voxels): 9176501 voxels (-2501931)
Final protein mask: 9176501 voxels

Final solvent mask: 6328020 voxels (40.8% of unit cell)

3. Computing smoothed solvent density...

Original binary mask:
  Shape: torch.Size([223, 277, 251])
  Min: 0.0000 (should be 0)
  Max: 1.0000 (should be 1)
  Mean: 0.4081
  Unique values: [0.0, 1.0]

Smoothed solvent density:
  Shape: torch.Size([223, 277, 251])
  Dtype: torch.float32
  Device: cpu
  Min: 0.000000
  Max: 0.350000
  Mean: 0.142849
  Std: 0.163884
  Number of unique values: 1870000 (should be > 2 for smooth)
  ✓ Mask has been smoothed (many intermediate values)

============================================================
4. Testing gradient flow through k_solvent
============================================================

Loss value: 2214809.0000
k_solvent = 0.3500, requires_grad = True

Computing gradients...

Gradients:
  dk_solvent/dloss = 6328025.000000

✓ Gradient computed successfully!
  The forward method is differentiable with respect to k_solvent.

============================================================
5. Testing k_solvent effect on smoothed density
============================================================

Effect of k_solvent on smoothed density:
  k_solvent = 0.10 → density mean = 0.040814, max = 0.100000
  k_solvent = 0.35 → density mean = 0.142849, max = 0.350000
  k_solvent = 0.50 → density mean = 0.204070, max = 0.500000
  k_solvent = 1.00 → density mean = 0.408141, max = 1.000001

✓ Expected: density scales linearly with k_solvent

============================================================
6. Checking conservation of solvent volume
============================================================
Original mask sum: 6328020.0
Smoothed mask sum: 6328025.0
Ratio: 1.0000
✓ Volume approximately conserved (within 10%)

============================================================
Test completed successfully!
============================================================
