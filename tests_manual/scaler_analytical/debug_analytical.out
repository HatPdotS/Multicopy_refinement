================================================================================
DEBUGGING ANALYTICAL SCALER
================================================================================

Loading model and data...
Could not find scattering factor for Ca 2 Exception that was raised: 'NoneType' object has no attribute 'a'
Try without charge
Could not find scattering factor for Mg 2 Exception that was raised: 'NoneType' object has no attribute 'a'
Try without charge
Loading MTZ file: /das/work/p17/p17490/Peter/Library/multicopy_refinement/test_data/tubulin/dark.mtz
Filtering: 123647/123647 reflections in range [50.0 - 1.5] Å
✓ Loaded 123647 reflections

================================================================================
1. CHECKING F_CALC AND F_MASK SCALES
================================================================================

F_calc amplitudes:
  Mean: 902.48
  Std:  1242.11
  Max:  18797.64

F_mask amplitudes:
  Mean: 414.10
  Std:  911.16
  Max:  24448.87

F_obs amplitudes:
  Mean: 29.46
  Std:  35.54
  Max:  380.90

Ratio F_mask/F_calc: 0.4588

================================================================================
2. CHECKING ANALYTICAL SCALER INTERNALS
================================================================================

======================================================================
Analytical Bulk-Solvent and Isotropic Scaling
======================================================================
Number of reflections: 123647
Resolution bins: 20

Computing analytical bulk-solvent scales...
  Bin 1/20:  6183 refs, d=1.71Å, k_mask=134.5128, K=963389.4375
  Bin 2/20:  6182 refs, d=1.74Å, k_mask=0.0000, K=404.7241
  Bin 3/20:  6183 refs, d=1.78Å, k_mask=0.0444, K=447.1184
  Bin 4/20:  6182 refs, d=1.81Å, k_mask=0.0000, K=513.1166
  Bin 5/20:  6182 refs, d=1.85Å, k_mask=0.0067, K=564.7114
  Bin 6/20:  6183 refs, d=1.89Å, k_mask=0.0028, K=605.1417
  Bin 7/20:  6182 refs, d=1.94Å, k_mask=0.0099, K=550.9341
  Bin 8/20:  6182 refs, d=1.99Å, k_mask=0.0358, K=660.0505
  Bin 9/20:  6183 refs, d=2.04Å, k_mask=0.0010, K=693.0995
  Bin 10/20:  6182 refs, d=2.11Å, k_mask=0.0003, K=714.2538
  Bin 11/20:  6182 refs, d=2.18Å, k_mask=0.0000, K=759.3773
  Bin 12/20:  6183 refs, d=2.26Å, k_mask=0.0000, K=808.3815
  Bin 13/20:  6182 refs, d=2.35Å, k_mask=0.0000, K=856.8000
  Bin 14/20:  6182 refs, d=2.47Å, k_mask=0.0000, K=836.2279
  Bin 15/20:  6183 refs, d=2.61Å, k_mask=0.0000, K=897.0257
  Bin 16/20:  6182 refs, d=2.78Å, k_mask=0.0000, K=938.9446
  Bin 17/20:  6182 refs, d=3.02Å, k_mask=0.0000, K=938.5005
  Bin 18/20:  6183 refs, d=3.37Å, k_mask=0.0000, K=945.7781
  Bin 19/20:  6182 refs, d=3.97Å, k_mask=0.1197, K=1067.2629
  Bin 20/20:  6182 refs, d=5.63Å, k_mask=0.2220, K=1338.2501

Analytical optimization complete:
  Valid bins: 14/20
  k_mask range: 0.0000 - 134.5128
  K range: 404.7241 - 963389.4375
======================================================================
Analytical scaling initialization complete
======================================================================


================================================================================
3. EXAMINING BIN-BY-BIN RESULTS
================================================================================

Analyzing each bin in detail:

 Bin  N_ref   d(Å)     k_mask               K   |F_calc|   |F_mask|      F_obs
-----------------------------------------------------------------------------------------------
   1   6183   0.86   134.5128        9.63e+05     145.68      58.16       7.76
   2   6182   0.87     0.0000        4.05e+02     163.09      64.14       7.85
   3   6183   0.89     0.0444        4.47e+02     179.55      69.93       8.28
   4   6182   0.91     0.0000        5.13e+02     201.85      77.39       8.73
   5   6182   0.93     0.0067        5.65e+02     228.13      85.74       9.42
   6   6183   0.95     0.0028        6.05e+02     259.66      94.71      10.35
   7   6182   0.97     0.0099        5.51e+02     300.55     107.14      12.27
   8   6182   0.99     0.0358        6.60e+02     349.31     118.01      13.35
   9   6183   1.02     0.0010        6.93e+02     406.70     135.62      15.15
  10   6182   1.05     0.0003        7.14e+02     459.58     152.26      16.97
  11   6182   1.09     0.0000        7.59e+02     538.29     173.77      19.32
  12   6183   1.13     0.0000        8.08e+02     614.07     202.93      21.40
  13   6182   1.18     0.0000        8.57e+02     709.03     237.22      24.04
  14   6182   1.23     0.0000        8.36e+02     824.59     282.34      27.91
  15   6183   1.30     0.0000        8.97e+02     964.85     340.27      32.07
  16   6182   1.39     0.0000        9.39e+02    1149.96     419.28      37.25
  17   6182   1.51     0.0000        9.39e+02    1486.80     545.80      48.31
  18   6183   1.69     0.0000        9.46e+02    2074.68     749.47      67.76
  19   6182   1.99     0.1197        1.07e+03    3165.56    1172.08      97.76
  20   6182   2.82     0.2220        1.34e+03    3827.83    3195.94     103.36

================================================================================
4. CHECKING WHY K_MASK IS ZERO IN MOST BINS
================================================================================

Investigating bin 2 (k_mask=0)...

Bin 2 statistics:
  N reflections: 6182
  u_s (|F_calc|^2) - mean: 3.37e+04, std: 3.40e+04
  v_s (Re[F_calc*F_mask*]) - mean: -5.71e+00, std: 9.53e+03
  w_s (|F_mask|^2) - mean: 5.40e+03, std: 5.96e+03
  I_s (F_obs^2) - mean: 8.34e+01, std: 1.06e+02

Cubic equation terms:
  A_2: 2.09e+08
  B_2: -4.25e+10
  C_2: 1.69e+12
  D_3: 4.74e+09
  Y_2: 5.15e+05
  Y_3: -3.22e+07
  E_4: 4.00e+11
  F_4: 9.48e+09
  G_4: 5.61e+11

Denominator: 3.59e+17

Cubic coefficients (k^3 + a*k^2 + b*k + c = 0):
  a: 3.59e+01
  b: -1.53e-01
  c: 1.52e+02

Roots of cubic equation:
  Root 1: (-36.04396003764715+0j) (real: True, positive: False)
  Root 2: (0.060512275903650076+2.050630020282142j) (real: False, positive: False)
  Root 3: (0.060512275903650076-2.050630020282142j) (real: False, positive: False)

Positive real roots: 0

================================================================================
5. COMPARING SCALERS ON SAME DATA
================================================================================

Analytical scaler:
  R-factor: 0.2365
  F_model mean: 29.53
  F_model/F_obs ratio: 1.0022

Old scaler:
  R-factor: 0.2412
  F_model mean: 29.71
  F_model/F_obs ratio: 1.0082

Old scaler bin scales:
  Bin 1: d=0.86Å, scale=0.0517
  Bin 2: d=0.87Å, scale=0.0470
  Bin 3: d=0.89Å, scale=0.0453
  Bin 4: d=0.91Å, scale=0.0428
  Bin 5: d=0.93Å, scale=0.0407
  Bin 6: d=0.95Å, scale=0.0397
  Bin 7: d=0.97Å, scale=0.0406
  Bin 8: d=0.99Å, scale=0.0382
  Bin 9: d=1.02Å, scale=0.0370
  Bin 10: d=1.05Å, scale=0.0370
  Bin 11: d=1.09Å, scale=0.0360
  Bin 12: d=1.13Å, scale=0.0351
  Bin 13: d=1.18Å, scale=0.0340
  Bin 14: d=1.23Å, scale=0.0340
  Bin 15: d=1.30Å, scale=0.0335
  Bin 16: d=1.39Å, scale=0.0324
  Bin 17: d=1.51Å, scale=0.0327
  Bin 18: d=1.69Å, scale=0.0333
  Bin 19: d=1.99Å, scale=0.0314
  Bin 20: d=2.82Å, scale=0.0275

================================================================================
6. TESTING SIMPLE BULK-SOLVENT SCALES
================================================================================

Testing different k_mask values (uniform across all bins):
  k_mask   R-factor  Improvement
--------------------------------
    0.00     0.2540      -0.0175
    0.10     0.2490      -0.0126
    0.20     0.2477      -0.0112
    0.50     0.2673      -0.0308
    1.00     0.3396      -0.1031
    2.00     0.4795      -0.2430
    5.00     0.6523      -0.4159

================================================================================
DEBUGGING COMPLETE
================================================================================
