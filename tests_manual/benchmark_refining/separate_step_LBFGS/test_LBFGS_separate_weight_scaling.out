Reading MTZ file: /das/work/p17/p17490/Peter/Library/multicopy_refinement/scientific_testing/data/1A0F/1A0F.mtz
Found R-free flags: FreeR_flag
  Unique flag values: [0, 1]
  Convention: 0=test(free), other=work
  Test set: 500 reflections (1.9%)
  Work set: 25470 reflections (98.1%)
found nan F values:  0
found nan F_sigma values:  0
Suspicious sigma detection: 37/25970 (0.14%) reflections flagged

Occupancy Setup:
  Total atoms: 3444
  Collapsed indices: 578
  Alternative conformation groups: 0
  Refinable atoms: 0
  Compression ratio: 5.96x
Building ITC92 parametrization...
Parametrization built for 4 unique atom types
Elements with parametrization: ['C', 'N', 'O', 'S']
Setting up grids with max_res=2.024353504180908 Å
Defining grid size for =2.024353504180908 Å
MapSymmetry initialized for P   2 1   2 1   2 1      
  Number of symmetry operations: 4
  Map shape: (134, 141, 75)
  Resolution bins:
    Bin  0:   1299 refl, resolution 2.02-2.09 Å
    Bin  1:   1298 refl, resolution 2.09-2.13 Å
    Bin  2:   1299 refl, resolution 2.13-2.18 Å
    Bin  3:   1298 refl, resolution 2.18-2.24 Å
    Bin  4:   1299 refl, resolution 2.24-2.29 Å
    Bin  5:   1298 refl, resolution 2.29-2.35 Å
    Bin  6:   1299 refl, resolution 2.35-2.42 Å
    Bin  7:   1298 refl, resolution 2.42-2.49 Å
    Bin  8:   1299 refl, resolution 2.49-2.56 Å
    Bin  9:   1298 refl, resolution 2.56-2.65 Å
    Bin 10:   1299 refl, resolution 2.65-2.75 Å
    Bin 11:   1298 refl, resolution 2.75-2.86 Å
    Bin 12:   1299 refl, resolution 2.86-3.00 Å
    Bin 13:   1298 refl, resolution 3.00-3.17 Å
    Bin 14:   1299 refl, resolution 3.17-3.37 Å
    Bin 15:   1298 refl, resolution 3.37-3.64 Å
    Bin 16:   1299 refl, resolution 3.64-4.03 Å
    Bin 17:   1298 refl, resolution 4.03-4.64 Å
    Bin 18:   1299 refl, resolution 4.64-5.90 Å
    Bin 19:   1298 refl, resolution 5.90-45.33 Å
Initialized Scaler with 20 bins.
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/m/MET.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/l/LYS.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/l/LEU.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/p/PHE.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/t/TYR.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/p/PRO.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/g/GLY.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/a/ALA.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/c/CYS.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/s/SER.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/h/HIS.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/i/ILE.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/t/THR.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/a/ARG.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/g/GLU.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/a/ASP.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/v/VAL.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/a/ASN.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/g/GLN.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/t/TRP.cif
/das/work/units/LBR-FEL/p17490/Peter/Library/multicopy_refinement/external_monomer_library/g/GTS.cif
Loading link definitions from monomer library...
Found 109 link definitions
Loaded 54 link types
Built 424 plane restraints with 3 atoms
Built 16 plane restraints with 7 atoms
Built 30 plane restraints with 8 atoms
Built 8 plane restraints with 6 atoms
Built 112 plane restraints with 4 atoms
Peptide bond parameters: C-N = 1.337 Å ± 0.0110 Å
Plane plan-1: 1:CA, 1:C, 2:N, 1:O (σ=0.100 Å)
Plane plan-2: 2:CA, 1:C, 2:H, 2:N (σ=0.100 Å)
Built 400 peptide bond restraints
Built 1200 peptide angle restraints
Built 400 peptide plane restraints (4 atoms each)
  plan-1: 400 planes
Disulfide bond parameters: SG-SG = 2.031 Å ± 0.0200 Å
Found 4 SG atoms
No disulfide bonds found (no SG atoms from different residues within 2.0 Å)

Building VDW (non-bonded) restraints...
Built exclusion set with 10208 bonded pairs (1-2, 1-3, 1-4)
  Found 41665 nearby pairs within 5.0 Å
  Built 31457 VDW restraints (all contacts)
  Minimum distance range: 2.90 - 3.60 Å
  Using sigma = 0.200 Å
  Cutoff distance: 5.0 Å
================================================================================
Restraints Summary
================================================================================
CIF file: None
Residue types in dictionary: 21

INTRA-RESIDUE RESTRAINTS:
--------------------------------------------------------------------------------
Bonds: 2940
  Shape: torch.Size([2940, 2])
  References: min=1.229Å, max=1.812Å, mean=1.446Å
  Sigmas: min=0.0100Å, max=0.0200Å, mean=0.0131Å

Angles: 3308
  Shape: torch.Size([3308, 3])
  References: min=100.693°, max=134.327°, mean=113.805°
  Sigmas: min=1.5000°, max=3.0000°, mean=1.9909°

Torsions: 1260
  Shape: torch.Size([1260, 4])
  References: min=-60.000°, max=180.000°, mean=44.857°
  Sigmas: min=5.0000°, max=10.0000°, mean=9.9048°
  Periods: [2, 3, 6]

PEPTIDE LINK RESTRAINTS:
--------------------------------------------------------------------------------
Bonds: 400
  Shape: torch.Size([400, 2])
  References: min=1.337Å, max=1.337Å, mean=1.337Å
  Sigmas: min=0.0110Å, max=0.0110Å, mean=0.0110Å

Angles: 1200
  Shape: torch.Size([1200, 3])
  References: min=115.917°, max=123.469°, mean=120.494°
  Sigmas: min=1.5000°, max=1.7600°, mean=1.5867°

BACKBONE TORSION ANGLES:
--------------------------------------------------------------------------------
Phi: 400
  Definition: C(i) - N(i+1) - CA(i+1) - C(i+1)
  Period: 3

Psi: 400
  Definition: N(i) - CA(i) - C(i) - N(i+1)
  Period: 2

Omega: 400
  Definition: CA(i) - C(i) - N(i+1) - CA(i+1)
  References: min=180.00°, max=180.00°, mean=180.00°
  Sigmas: min=5.0000°, max=5.0000°, mean=5.0000°
  Period: 0

PLANE RESTRAINTS:
--------------------------------------------------------------------------------
3_atoms: 424 planes
  Shape: torch.Size([424, 3])
  Sigmas: min=0.1000Å, max=0.1000Å, mean=0.1000Å

4_atoms: 512 planes
  Shape: torch.Size([512, 4])
  Sigmas: min=0.1000Å, max=0.1000Å, mean=0.1000Å

6_atoms: 8 planes
  Shape: torch.Size([8, 6])
  Sigmas: min=0.1000Å, max=0.1000Å, mean=0.1000Å

7_atoms: 16 planes
  Shape: torch.Size([16, 7])
  Sigmas: min=0.1000Å, max=0.1000Å, mean=0.1000Å

8_atoms: 30 planes
  Shape: torch.Size([30, 8])
  Sigmas: min=0.1000Å, max=0.1000Å, mean=0.1000Å


VDW (NON-BONDED) RESTRAINTS:
--------------------------------------------------------------------------------
Pairs: 31457
  Min distances: 2.900 - 3.600 Å (mean=3.302 Å)
  Sigma: 0.200 Å
  Current violations: 2875 (9.1%)
  Violation range: 0.000 - 1.551 Å (mean=0.319 Å)
================================================================================
Calculating initial scale factors using 20 bins.
Initial scale factors per bin: [-2.9363995 -2.9035606 -2.862314  -2.8335123 -2.795298  -2.7842433
 -2.7702825 -2.7744856 -2.734818  -2.7483788 -2.763093  -2.7334957
 -2.7031257 -2.6778638 -2.6625195 -2.662851  -2.655235  -2.6427433
 -2.733482  -3.0048032]
Calculated radius for density calculation: 2 voxels (voxel size: tensor([0.6765, 0.6765, 0.6828])), this corresponds to at least 1.1 Å

=== Phenix-Style Bulk Solvent Mask Calculation (VECTORIZED) ===
Solvent radius (dilation): 1.10 Å
Shrink truncation radius (erosion): 0.90 Å
Total solvent voxels: 588945 / 1417050 (41.56%)
Outlier detection: 111/25970 (0.43%) outliers found
  Log-ratio statistics: mean=0.015, std=0.672
  Z-score threshold: 4.0
Outlier detection: 111 reflections flagged as outliers out of 25970.
Refining scales with LBFGS...
  Step 1/5: Rwork=0.3203, Rfree=0.3163, NLL_work=121.25, NLL_test=122.12
  Step 2/5: Rwork=0.3206, Rfree=0.3162, NLL_work=121.21, NLL_test=121.46
  Step 3/5: Rwork=0.3206, Rfree=0.3172, NLL_work=121.04, NLL_test=120.87
  Step 4/5: Rwork=0.3209, Rfree=0.3155, NLL_work=120.87, NLL_test=119.60
  Step 5/5: Rwork=0.3209, Rfree=0.3154, NLL_work=120.87, NLL_test=119.60
Scale refinement complete.

Outlier detection: 112/25970 (0.43%) outliers found
  Log-ratio statistics: mean=0.126, std=0.669
  Z-score threshold: 4.0
Outlier detection: 112 reflections flagged as outliers out of 25970.
Effective weights: {'xray': 1.0, 'restraints': 1.9985236482614614, 'adp': 4.996301559872089}
torch.Size([3444, 3])
torch.Size([3444])
torch.Size([0, 6])
torch.Size([0])
Target: xyz, X-ray work: 89.6402, X-ray test: 121.9067, Rwork: 0.2836, Rfree: 0.2871
Target: b, X-ray work: 82.9639, X-ray test: 124.7405, Rwork: 0.2692, Rfree: 0.2636

Occupancy Setup:
  Total atoms: 3444
  Collapsed indices: 578
  Alternative conformation groups: 0
  Refinable atoms: 0
  Compression ratio: 5.96x
✓ Model copied successfully (3444 atoms)
Saved refined model to /das/work/p17/p17490/Peter/Library/multicopy_refinement/tests_manual/benchmark_refining/separate_step_LBFGS/refined_model_round_1.pdb with Rfree: 0.2636
Calculating initial scale factors using 20 bins.
Initial scale factors per bin: [-2.7997215 -2.763324  -2.7234926 -2.695418  -2.6830993 -2.6688676
 -2.6998541 -2.6712906 -2.6458132 -2.672088  -2.6797535 -2.6830623
 -2.6653614 -2.6271102 -2.6154034 -2.6325173 -2.6413202 -2.6570597
 -2.740597  -3.003587 ]
Calculated radius for density calculation: 2 voxels (voxel size: tensor([0.6765, 0.6765, 0.6828])), this corresponds to at least 1.1 Å

=== Phenix-Style Bulk Solvent Mask Calculation (VECTORIZED) ===
Solvent radius (dilation): 1.10 Å
Shrink truncation radius (erosion): 0.90 Å
Total solvent voxels: 590169 / 1417050 (41.65%)
Outlier detection: 166/25970 (0.64%) outliers found
  Log-ratio statistics: mean=0.023, std=0.581
  Z-score threshold: 4.0
Outlier detection: 166 reflections flagged as outliers out of 25970.
Refining scales with LBFGS...
  Step 1/5: Rwork=0.2548, Rfree=0.2547, NLL_work=77.59, NLL_test=98.32
  Step 2/5: Rwork=0.2557, Rfree=0.2573, NLL_work=77.47, NLL_test=97.74
  Step 3/5: Rwork=0.2553, Rfree=0.2543, NLL_work=76.88, NLL_test=94.18
  Step 4/5: Rwork=0.2550, Rfree=0.2538, NLL_work=76.86, NLL_test=94.24
  Step 5/5: Rwork=0.2550, Rfree=0.2538, NLL_work=76.86, NLL_test=94.25
Scale refinement complete.

Outlier detection: 173/25970 (0.67%) outliers found
  Log-ratio statistics: mean=0.072, std=0.575
  Z-score threshold: 4.0
Outlier detection: 173 reflections flagged as outliers out of 25970.
Effective weights: {'xray': 1.0, 'restraints': 1.81013445665797, 'adp': 4.5168894986393076}
torch.Size([3444, 3])
torch.Size([3444])
torch.Size([0, 6])
torch.Size([0])
Target: xyz, X-ray work: 53.5377, X-ray test: 79.6746, Rwork: 0.2175, Rfree: 0.2325
Target: b, X-ray work: 86.2992, X-ray test: 126.2600, Rwork: 0.2961, Rfree: 0.3062

Occupancy Setup:
  Total atoms: 3444
  Collapsed indices: 578
  Alternative conformation groups: 0
  Refinable atoms: 0
  Compression ratio: 5.96x
✓ Model copied successfully (3444 atoms)
Saved refined model to /das/work/p17/p17490/Peter/Library/multicopy_refinement/tests_manual/benchmark_refining/separate_step_LBFGS/refined_model_round_2.pdb with Rfree: 0.3062
Calculating initial scale factors using 20 bins.
Initial scale factors per bin: [-2.7702942 -2.7601926 -2.7300434 -2.6979723 -2.7014248 -2.6779978
 -2.7056627 -2.684704  -2.6789784 -2.6715925 -2.6793945 -2.6782217
 -2.6640472 -2.6469889 -2.6379151 -2.6308296 -2.6517336 -2.6660106
 -2.7574868 -3.0073946]
Calculated radius for density calculation: 2 voxels (voxel size: tensor([0.6765, 0.6765, 0.6828])), this corresponds to at least 1.1 Å

=== Phenix-Style Bulk Solvent Mask Calculation (VECTORIZED) ===
Solvent radius (dilation): 1.10 Å
Shrink truncation radius (erosion): 0.90 Å
Total solvent voxels: 591668 / 1417050 (41.75%)
Outlier detection: 187/25970 (0.72%) outliers found
  Log-ratio statistics: mean=0.020, std=0.522
  Z-score threshold: 4.0
Outlier detection: 187 reflections flagged as outliers out of 25970.
Refining scales with LBFGS...
  Step 1/5: Rwork=0.2168, Rfree=0.2295, NLL_work=54.05, NLL_test=80.05
  Step 2/5: Rwork=0.2171, Rfree=0.2301, NLL_work=53.83, NLL_test=79.71
  Step 3/5: Rwork=0.2168, Rfree=0.2283, NLL_work=53.41, NLL_test=77.34
  Step 4/5: Rwork=0.2168, Rfree=0.2286, NLL_work=53.39, NLL_test=77.26
  Step 5/5: Rwork=0.2168, Rfree=0.2286, NLL_work=53.39, NLL_test=77.25
Scale refinement complete.

Outlier detection: 189/25970 (0.73%) outliers found
  Log-ratio statistics: mean=0.039, std=0.517
  Z-score threshold: 4.0
Outlier detection: 189 reflections flagged as outliers out of 25970.
Effective weights: {'xray': 1.0, 'restraints': 1.987836255936151, 'adp': 4.955572000953258}
torch.Size([3444, 3])
torch.Size([3444])
torch.Size([0, 6])
torch.Size([0])
Target: xyz, X-ray work: 45.2905, X-ray test: 78.3964, Rwork: 0.2028, Rfree: 0.2255
Target: b, X-ray work: 287.7740, X-ray test: 467.4800, Rwork: 0.5653, Rfree: 0.5865

Occupancy Setup:
  Total atoms: 3444
  Collapsed indices: 578
  Alternative conformation groups: 0
  Refinable atoms: 0
  Compression ratio: 5.96x
✓ Model copied successfully (3444 atoms)
Saved refined model to /das/work/p17/p17490/Peter/Library/multicopy_refinement/tests_manual/benchmark_refining/separate_step_LBFGS/refined_model_round_3.pdb with Rfree: 0.5865
